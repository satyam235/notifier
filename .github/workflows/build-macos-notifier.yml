name: Build macOS Reboot Notifier

on:
  push:
    branches: [ dev_satyam_adding_macos_patch_support, main, master ]
    paths:
      - 'macos_notifier/SecOpsRebootNotifier/**'
      - '.github/workflows/build-macos-notifier.yml'
  pull_request:
    branches: [ dev_satyam_adding_macos_patch_support, main, master ]
    paths:
      - 'macos_notifier/SecOpsRebootNotifier/**'
  workflow_dispatch: # Allows manual trigger

jobs:
  build:
    name: Build SecOpsRebootNotifier
    runs-on: macos-latest # Uses latest macOS with Xcode installed
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.0.1.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
    
    - name: Show Xcode version
      run: xcodebuild -version
    
    - name: List available schemes
      working-directory: macos_notifier/SecOpsRebootNotifier
      run: xcodebuild -list
    
    - name: Build macOS app (Intel x86_64)
      working-directory: macos_notifier/SecOpsRebootNotifier
      run: |
        xcodebuild \
          -scheme SecOpsRebootNotifier \
          -configuration Release \
          -derivedDataPath ./build \
          -arch x86_64 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Build macOS app (Apple Silicon arm64)
      working-directory: macos_notifier/SecOpsRebootNotifier
      run: |
        xcodebuild \
          -scheme SecOpsRebootNotifier \
          -configuration Release \
          -derivedDataPath ./build_arm64 \
          -arch arm64 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Build Universal Binary (x86_64 + arm64)
      working-directory: macos_notifier/SecOpsRebootNotifier
      run: |
        xcodebuild \
          -scheme SecOpsRebootNotifier \
          -configuration Release \
          -derivedDataPath ./build_universal \
          -arch x86_64 -arch arm64 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Locate built apps
      working-directory: macos_notifier/SecOpsRebootNotifier
      run: |
        echo "=== Intel x86_64 build ==="
        find ./build -name "*.app" -type d
        echo ""
        echo "=== Apple Silicon arm64 build ==="
        find ./build_arm64 -name "*.app" -type d
        echo ""
        echo "=== Universal Binary build ==="
        find ./build_universal -name "*.app" -type d
    
    - name: Create distribution folder
      run: |
        mkdir -p distribution/intel
        mkdir -p distribution/arm64
        mkdir -p distribution/universal
    
    - name: Copy built apps to distribution
      working-directory: macos_notifier/SecOpsRebootNotifier
      run: |
        # Copy Intel build
        cp -R build/Build/Products/Release/SecOpsRebootNotifier.app ../../distribution/intel/ || \
        cp -R build/Build/Products/Release-macosx/SecOpsRebootNotifier.app ../../distribution/intel/ || \
        echo "Intel build not found at expected location"

        # Copy ARM64 build
        cp -R build_arm64/Build/Products/Release/SecOpsRebootNotifier.app ../../distribution/arm64/ || \
        cp -R build_arm64/Build/Products/Release-macosx/SecOpsRebootNotifier.app ../../distribution/arm64/ || \
        echo "ARM64 build not found at expected location"

        # Copy Universal build
        cp -R build_universal/Build/Products/Release/SecOpsRebootNotifier.app ../../distribution/universal/ || \
        cp -R build_universal/Build/Products/Release-macosx/SecOpsRebootNotifier.app ../../distribution/universal/ || \
        echo "Universal build not found at expected location"
        
        - name: Create ZIP archives
          run: |
            cd distribution/intel && zip -r ../../SecOpsRebootNotifier-x86_64.zip SecOpsRebootNotifier.app || echo "No Intel app to zip"
            cd ../arm64 && zip -r ../../SecOpsRebootNotifier-arm64.zip SecOpsRebootNotifier.app || echo "No ARM64 app to zip"
            cd ../universal && zip -r ../../SecOpsRebootNotifier-universal.zip SecOpsRebootNotifier.app || echo "No Universal app to zip"
            cd ../..
            ls -lh *.zip || echo "No zip files created"
        
        - name: Upload Intel (x86_64) artifact
          uses: actions/upload-artifact@v4
          if: hashFiles('SecOpsRebootNotifier-x86_64.zip') != ''
          with:
            name: SecOpsRebootNotifier-Intel-x86_64
            path: SecOpsRebootNotifier-x86_64.zip
            retention-days: 30
        
        - name: Upload ARM64 (Apple Silicon) artifact
          uses: actions/upload-artifact@v4
          if: hashFiles('SecOpsRebootNotifier-arm64.zip') != ''
          with:
            name: SecOpsRebootNotifier-AppleSilicon-arm64
            path: SecOpsRebootNotifier-arm64.zip
            retention-days: 30
    
    - name: Upload Universal Binary artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('SecOpsRebootNotifier-universal.zip') != ''
      with:
        name: SecOpsRebootNotifier-Universal
        path: SecOpsRebootNotifier-universal.zip
        retention-days: 30
    
    - name: Build Summary
      run: |
        echo "## Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Built SecOpsRebootNotifier for macOS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- Intel (x86_64) build" >> $GITHUB_STEP_SUMMARY
        echo "- Apple Silicon (arm64) build" >> $GITHUB_STEP_SUMMARY
        echo "- Universal Binary (both architectures)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download the artifacts from the 'Artifacts' section above." >> $GITHUB_STEP_SUMMARY
